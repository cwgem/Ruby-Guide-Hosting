<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Module: Gem::Security
  
    &mdash; Ruby 1.9 Ruby Standard Library
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '..';
  if (relpath != '') relpath += '/';
</script>

  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="../_index.html">Index (S)</a> &raquo; 
    <span class='title'><span class='object_link'><a href="../Gem.html" title="Gem (module)">Gem</a></span></span>
     &raquo; 
    <span class="title">Security</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a id="class_list_link" href="#">Class List</a>
  
    <a id="method_list_link" href="#">Method List</a>
  
    <a id="file_list_link" href="#">File List</a>
  
</div>
      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Module: Gem::Security
  
  
  
</h1>

<dl class="box">
  
  
    
  
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">lib/rubygems/security.rb<span class="defines">,<br />
  lib/rubygems/install_update_options.rb</span>
</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>forward-declare</p>


  </div>
</div>
<div class="tags">
  
</div><h2>Defined Under Namespace</h2>
<p class="children">
   
    
   
    
      <strong class="classes">Classes:</strong> <span class='object_link'><a href="Security/Exception.html" title="Gem::Security::Exception (class)">Exception</a></span>, <span class='object_link'><a href="Security/Policy.html" title="Gem::Security::Policy (class)">Policy</a></span>, <span class='object_link'><a href="Security/Signer.html" title="Gem::Security::Signer (class)">Signer</a></span>
    
  
</p>

  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="OPT-constant" class="">OPT =
          <div class="docstring">
  <div class="discussion">
    
<p>Default options for most of the methods below</p>


  </div>
</div>
<div class="tags">
  
</div>
        </dt>
        <dd><pre class="code"><span class='lbrace'>{</span>
  <span class='comment'># private key options
</span>  <span class='symbol'>:key_algo</span>   <span class='op'>=&gt;</span> <span class='const'>Gem</span><span class='op'>::</span><span class='const'>SSL</span><span class='op'>::</span><span class='const'>PKEY_RSA</span><span class='comma'>,</span>
  <span class='symbol'>:key_size</span>   <span class='op'>=&gt;</span> <span class='int'>2048</span><span class='comma'>,</span>

  <span class='comment'># public cert options
</span>  <span class='symbol'>:cert_age</span>   <span class='op'>=&gt;</span> <span class='int'>365</span> <span class='op'>*</span> <span class='int'>24</span> <span class='op'>*</span> <span class='int'>3600</span><span class='comma'>,</span> <span class='comment'># 1 year
</span>  <span class='symbol'>:dgst_algo</span>  <span class='op'>=&gt;</span> <span class='const'>Gem</span><span class='op'>::</span><span class='const'>SSL</span><span class='op'>::</span><span class='const'>DIGEST_SHA1</span><span class='comma'>,</span>

  <span class='comment'># x509 certificate extensions
</span>  <span class='symbol'>:cert_exts</span>  <span class='op'>=&gt;</span> <span class='lbrace'>{</span>
    <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>basicConstraints</span><span class='tstring_end'>'</span></span>      <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>CA:FALSE</span><span class='tstring_end'>'</span></span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>subjectKeyIdentifier</span><span class='tstring_end'>'</span></span>  <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>hash</span><span class='tstring_end'>'</span></span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>keyUsage</span><span class='tstring_end'>'</span></span>              <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>keyEncipherment,dataEncipherment,digitalSignature</span><span class='tstring_end'>'</span></span><span class='comma'>,</span>
  <span class='rbrace'>}</span><span class='comma'>,</span>

  <span class='comment'># save the key and cert to a file in build_self_signed_cert()?
</span>  <span class='symbol'>:save_key</span>   <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:save_cert</span>  <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>

  <span class='comment'># if you define either of these, then they'll be used instead of
</span>  <span class='comment'># the output_fmt macro below
</span>  <span class='symbol'>:save_key_path</span> <span class='op'>=&gt;</span> <span class='kw'>nil</span><span class='comma'>,</span>
  <span class='symbol'>:save_cert_path</span> <span class='op'>=&gt;</span> <span class='kw'>nil</span><span class='comma'>,</span>

  <span class='comment'># output name format for self-signed certs
</span>  <span class='symbol'>:output_fmt</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>gem-%s.pem</span><span class='tstring_end'>'</span></span><span class='comma'>,</span>
  <span class='symbol'>:munge_re</span>   <span class='op'>=&gt;</span> <span class='const'>Regexp</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>[^a-z0-9_.-]+</span><span class='regexp_end'>/</span></span><span class='rparen'>)</span><span class='comma'>,</span>

  <span class='comment'># output directory for trusted certificate checksums
</span>  <span class='symbol'>:trust_dir</span> <span class='op'>=&gt;</span> <span class='const'>File</span><span class='period'>.</span><span class='id join'>join</span><span class='lparen'>(</span><span class='const'>Gem</span><span class='period'>.</span><span class='id user_home'>user_home</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>.gem</span><span class='tstring_end'>'</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>trust</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span><span class='comma'>,</span>

  <span class='comment'># default permissions for trust directory and certs
</span>  <span class='symbol'>:perms</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span>
    <span class='symbol'>:trust_dir</span>      <span class='op'>=&gt;</span> <span class='int'>0700</span><span class='comma'>,</span>
    <span class='symbol'>:trusted_cert</span>   <span class='op'>=&gt;</span> <span class='int'>0600</span><span class='comma'>,</span>
    <span class='symbol'>:signing_cert</span>   <span class='op'>=&gt;</span> <span class='int'>0600</span><span class='comma'>,</span>
    <span class='symbol'>:signing_key</span>    <span class='op'>=&gt;</span> <span class='int'>0600</span><span class='comma'>,</span>
  <span class='rbrace'>}</span><span class='comma'>,</span>
<span class='rbrace'>}</span></pre></dd>
      
        <dt id="NoSecurity-constant" class="">NoSecurity =
          <div class="docstring">
  <div class="discussion">
    
<p>No security policy: all package signature checks are disabled.</p>


  </div>
</div>
<div class="tags">
  
</div>
        </dt>
        <dd><pre class="code"><span class='const'>Policy</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span>
  <span class='symbol'>:verify_data</span>      <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
  <span class='symbol'>:verify_signer</span>    <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
  <span class='symbol'>:verify_chain</span>     <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
  <span class='symbol'>:verify_root</span>      <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
  <span class='symbol'>:only_trusted</span>     <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
  <span class='symbol'>:only_signed</span>      <span class='op'>=&gt;</span> <span class='kw'>false</span>
<span class='rparen'>)</span></pre></dd>
      
        <dt id="AlmostNoSecurity-constant" class="">AlmostNoSecurity =
          <div class="docstring">
  <div class="discussion">
    
<p>AlmostNo security policy: only verify that the signing certificate is the
one that actually signed the data.  Make no attempt to verify the signing
certificate chain.</p>

<p>This policy is basically useless. better than nothing, but can still be
easily spoofed, and is not recommended.</p>


  </div>
</div>
<div class="tags">
  
</div>
        </dt>
        <dd><pre class="code"><span class='const'>Policy</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span>
  <span class='symbol'>:verify_data</span>      <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:verify_signer</span>    <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
  <span class='symbol'>:verify_chain</span>     <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
  <span class='symbol'>:verify_root</span>      <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
  <span class='symbol'>:only_trusted</span>     <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
  <span class='symbol'>:only_signed</span>      <span class='op'>=&gt;</span> <span class='kw'>false</span>
<span class='rparen'>)</span></pre></dd>
      
        <dt id="LowSecurity-constant" class="">LowSecurity =
          <div class="docstring">
  <div class="discussion">
    
<p>Low security policy: only verify that the signing certificate is actually
the gem signer, and that the signing certificate is valid.</p>

<p>This policy is better than nothing, but can still be easily spoofed, and is
not recommended.</p>


  </div>
</div>
<div class="tags">
  
</div>
        </dt>
        <dd><pre class="code"><span class='const'>Policy</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span>
  <span class='symbol'>:verify_data</span>      <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:verify_signer</span>    <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:verify_chain</span>     <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
  <span class='symbol'>:verify_root</span>      <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
  <span class='symbol'>:only_trusted</span>     <span class='op'>=&gt;</span> <span class='kw'>false</span><span class='comma'>,</span>
  <span class='symbol'>:only_signed</span>      <span class='op'>=&gt;</span> <span class='kw'>false</span>
<span class='rparen'>)</span></pre></dd>
      
        <dt id="MediumSecurity-constant" class="">MediumSecurity =
          <div class="docstring">
  <div class="discussion">
    
<p>Medium security policy: verify the signing certificate, verify the signing
certificate chain all the way to the root certificate, and only trust root
certificates that we have explicitly allowed trust for.</p>

<p>This security policy is reasonable, but it allows unsigned packages, so a
malicious person could simply delete the package signature and pass the gem
off as unsigned.</p>


  </div>
</div>
<div class="tags">
  
</div>
        </dt>
        <dd><pre class="code"><span class='const'>Policy</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span>
  <span class='symbol'>:verify_data</span>      <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:verify_signer</span>    <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:verify_chain</span>     <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:verify_root</span>      <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:only_trusted</span>     <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:only_signed</span>      <span class='op'>=&gt;</span> <span class='kw'>false</span>
<span class='rparen'>)</span></pre></dd>
      
        <dt id="HighSecurity-constant" class="">HighSecurity =
          <div class="docstring">
  <div class="discussion">
    
<p>High security policy: only allow signed gems to be installed, verify the
signing certificate, verify the signing certificate chain all the way to
the root certificate, and only trust root certificates that we have
explicitly allowed trust for.</p>

<p>This security policy is significantly more difficult to bypass, and offers
a reasonable guarantee that the contents of the gem have not been altered.</p>


  </div>
</div>
<div class="tags">
  
</div>
        </dt>
        <dd><pre class="code"><span class='const'>Policy</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span>
  <span class='symbol'>:verify_data</span>      <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:verify_signer</span>    <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:verify_chain</span>     <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:verify_root</span>      <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:only_trusted</span>     <span class='op'>=&gt;</span> <span class='kw'>true</span><span class='comma'>,</span>
  <span class='symbol'>:only_signed</span>      <span class='op'>=&gt;</span> <span class='kw'>true</span>
<span class='rparen'>)</span></pre></dd>
      
        <dt id="Policies-constant" class="">Policies =
          <div class="docstring">
  <div class="discussion">
    
<p>Hash of configured security policies</p>


  </div>
</div>
<div class="tags">
  
</div>
        </dt>
        <dd><pre class="code"><span class='lbrace'>{</span>
  <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>NoSecurity</span><span class='tstring_end'>'</span></span>       <span class='op'>=&gt;</span> <span class='const'>NoSecurity</span><span class='comma'>,</span>
  <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>AlmostNoSecurity</span><span class='tstring_end'>'</span></span> <span class='op'>=&gt;</span> <span class='const'>AlmostNoSecurity</span><span class='comma'>,</span>
  <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>LowSecurity</span><span class='tstring_end'>'</span></span>      <span class='op'>=&gt;</span> <span class='const'>LowSecurity</span><span class='comma'>,</span>
  <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>MediumSecurity</span><span class='tstring_end'>'</span></span>   <span class='op'>=&gt;</span> <span class='const'>MediumSecurity</span><span class='comma'>,</span>
  <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>HighSecurity</span><span class='tstring_end'>'</span></span>     <span class='op'>=&gt;</span> <span class='const'>HighSecurity</span><span class='comma'>,</span>
<span class='rbrace'>}</span></pre></dd>
      
    </dl>
  





  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#add_trusted_cert-class_method" title="add_trusted_cert (class method)">+ (Object) <strong>add_trusted_cert</strong>(cert, opt = {}) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Add certificate to trusted cert list.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#build_cert-class_method" title="build_cert (class method)">+ (Object) <strong>build_cert</strong>(name, key, opt = {}) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Build a certificate from the given DN and private key.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#build_self_signed_cert-class_method" title="build_self_signed_cert (class method)">+ (Object) <strong>build_self_signed_cert</strong>(email_addr, opt = {}) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Build a self-signed certificate for the given email address.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#email_to_name-class_method" title="email_to_name (class method)">+ (Object) <strong>email_to_name</strong>(email_address, munge_re) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Turns <tt>email_address</tt> into an OpenSSL::X509::Name.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#sign_cert-class_method" title="sign_cert (class method)">+ (Object) <strong>sign_cert</strong>(cert, signing_key, signing_cert, opt = {}) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Sign the cert cert with @signing_key and @signing_cert, using the digest
algorithm opt[:dgst_algo].</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#verify_trust_dir-class_method" title="verify_trust_dir (class method)">+ (Object) <strong>verify_trust_dir</strong>(path, perms) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Make sure the trust directory exists.</p>
</div></span>
  
</li>

      
    </ul>
  



  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="add_trusted_cert-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>add_trusted_cert</strong>(cert, opt = {}) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Add certificate to trusted cert list.</p>

<p>Note: At the moment these are stored in OPT[:trust_dir], although that
directory may change in the future.</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


764
765
766
767
768
769
770
771
772
773
774
775
776
777
778
779
780
781</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rubygems/security.rb', line 764</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id add_trusted_cert'>add_trusted_cert</span><span class='lparen'>(</span><span class='id cert'>cert</span><span class='comma'>,</span> <span class='id opt'>opt</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id opt'>opt</span> <span class='op'>=</span> <span class='const'>OPT</span><span class='period'>.</span><span class='id merge'>merge</span><span class='lparen'>(</span><span class='id opt'>opt</span><span class='rparen'>)</span>

  <span class='comment'># get destination path
</span>  <span class='id path'>path</span> <span class='op'>=</span> <span class='const'>Gem</span><span class='op'>::</span><span class='const'>Security</span><span class='op'>::</span><span class='const'>Policy</span><span class='period'>.</span><span class='id trusted_cert_path'>trusted_cert_path</span><span class='lparen'>(</span><span class='id cert'>cert</span><span class='comma'>,</span> <span class='id opt'>opt</span><span class='rparen'>)</span>

  <span class='comment'># verify trust directory (can't write to nowhere, you know)
</span>  <span class='id verify_trust_dir'>verify_trust_dir</span><span class='lparen'>(</span><span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:trust_dir</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:perms</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:trust_dir</span><span class='rbracket'>]</span><span class='rparen'>)</span>

  <span class='comment'># write cert to output file
</span>  <span class='const'>File</span><span class='period'>.</span><span class='id open'>open</span><span class='lparen'>(</span><span class='id path'>path</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>wb</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id file'>file</span><span class='op'>|</span>
    <span class='id file'>file</span><span class='period'>.</span><span class='id chmod'>chmod</span><span class='lparen'>(</span><span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:perms</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:trusted_cert</span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id file'>file</span><span class='period'>.</span><span class='id write'>write</span><span class='lparen'>(</span><span class='id cert'>cert</span><span class='period'>.</span><span class='id to_pem'>to_pem</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># return nil
</span>  <span class='kw'>nil</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="build_cert-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>build_cert</strong>(name, key, opt = {}) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Build a certificate from the given DN and private key.</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


674
675
676
677
678
679
680
681
682
683
684
685
686
687
688
689
690
691
692
693
694
695
696
697
698
699</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rubygems/security.rb', line 674</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id build_cert'>build_cert</span><span class='lparen'>(</span><span class='id name'>name</span><span class='comma'>,</span> <span class='id key'>key</span><span class='comma'>,</span> <span class='id opt'>opt</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='const'>Gem</span><span class='period'>.</span><span class='id ensure_ssl_available'>ensure_ssl_available</span>
  <span class='id opt'>opt</span> <span class='op'>=</span> <span class='const'>OPT</span><span class='period'>.</span><span class='id merge'>merge</span> <span class='id opt'>opt</span>

  <span class='id cert'>cert</span> <span class='op'>=</span> <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>X509</span><span class='op'>::</span><span class='const'>Certificate</span><span class='period'>.</span><span class='id new'>new</span>

  <span class='id cert'>cert</span><span class='period'>.</span><span class='id not_after'>not_after</span>  <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id now'>now</span> <span class='op'>+</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:cert_age</span><span class='rbracket'>]</span>
  <span class='id cert'>cert</span><span class='period'>.</span><span class='id not_before'>not_before</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id now'>now</span>
  <span class='id cert'>cert</span><span class='period'>.</span><span class='id public_key'>public_key</span> <span class='op'>=</span> <span class='id key'>key</span><span class='period'>.</span><span class='id public_key'>public_key</span>
  <span class='id cert'>cert</span><span class='period'>.</span><span class='id serial'>serial</span>     <span class='op'>=</span> <span class='int'>0</span>
  <span class='id cert'>cert</span><span class='period'>.</span><span class='id subject'>subject</span>    <span class='op'>=</span> <span class='id name'>name</span>
  <span class='id cert'>cert</span><span class='period'>.</span><span class='id version'>version</span>    <span class='op'>=</span> <span class='int'>2</span>

  <span class='id ef'>ef</span> <span class='op'>=</span> <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>X509</span><span class='op'>::</span><span class='const'>ExtensionFactory</span><span class='period'>.</span><span class='id new'>new</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id cert'>cert</span>

  <span class='id cert'>cert</span><span class='period'>.</span><span class='id extensions'>extensions</span> <span class='op'>=</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:cert_exts</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id ext_name'>ext_name</span><span class='comma'>,</span> <span class='id value'>value</span><span class='op'>|</span>
    <span class='id ef'>ef</span><span class='period'>.</span><span class='id create_extension'>create_extension</span> <span class='id ext_name'>ext_name</span><span class='comma'>,</span> <span class='id value'>value</span>
  <span class='kw'>end</span>

  <span class='id i_key'>i_key</span>  <span class='op'>=</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:issuer_key</span><span class='rbracket'>]</span>  <span class='op'>||</span> <span class='id key'>key</span>
  <span class='id i_cert'>i_cert</span> <span class='op'>=</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:issuer_cert</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='id cert'>cert</span>

  <span class='id cert'>cert</span> <span class='op'>=</span> <span class='id sign_cert'>sign_cert</span> <span class='id cert'>cert</span><span class='comma'>,</span> <span class='id i_key'>i_key</span><span class='comma'>,</span> <span class='id i_cert'>i_cert</span><span class='comma'>,</span> <span class='id opt'>opt</span>

  <span class='id cert'>cert</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="build_self_signed_cert-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>build_self_signed_cert</strong>(email_addr, opt = {}) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Build a self-signed certificate for the given email address.</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


704
705
706
707
708
709
710
711
712
713
714
715
716
717
718
719
720
721
722
723
724
725
726
727
728
729
730
731
732
733
734
735
736
737</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rubygems/security.rb', line 704</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id build_self_signed_cert'>build_self_signed_cert</span><span class='lparen'>(</span><span class='id email_addr'>email_addr</span><span class='comma'>,</span> <span class='id opt'>opt</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='const'>Gem</span><span class='period'>.</span><span class='id ensure_ssl_available'>ensure_ssl_available</span>
  <span class='id opt'>opt</span> <span class='op'>=</span> <span class='const'>OPT</span><span class='period'>.</span><span class='id merge'>merge</span><span class='lparen'>(</span><span class='id opt'>opt</span><span class='rparen'>)</span>
  <span class='id path'>path</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='symbol'>:key</span> <span class='op'>=&gt;</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='symbol'>:cert</span> <span class='op'>=&gt;</span> <span class='kw'>nil</span> <span class='rbrace'>}</span>

  <span class='id name'>name</span> <span class='op'>=</span> <span class='id email_to_name'>email_to_name</span> <span class='id email_addr'>email_addr</span><span class='comma'>,</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:munge_re</span><span class='rbracket'>]</span>

  <span class='id key'>key</span> <span class='op'>=</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:key_algo</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id new'>new</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:key_size</span><span class='rbracket'>]</span>

  <span class='id verify_trust_dir'>verify_trust_dir</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:trust_dir</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:perms</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:trust_dir</span><span class='rbracket'>]</span>

  <span class='kw'>if</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:save_key</span><span class='rbracket'>]</span> <span class='kw'>then</span>
    <span class='id path'>path</span><span class='lbracket'>[</span><span class='symbol'>:key</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:save_key_path</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='lparen'>(</span><span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:output_fmt</span><span class='rbracket'>]</span> <span class='op'>%</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>private_key</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>

    <span class='id open'>open</span> <span class='id path'>path</span><span class='lbracket'>[</span><span class='symbol'>:key</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>wb</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id io'>io</span><span class='op'>|</span>
      <span class='id io'>io</span><span class='period'>.</span><span class='id chmod'>chmod</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:perms</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:signing_key</span><span class='rbracket'>]</span>
      <span class='id io'>io</span><span class='period'>.</span><span class='id write'>write</span> <span class='id key'>key</span><span class='period'>.</span><span class='id to_pem'>to_pem</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id cert'>cert</span> <span class='op'>=</span> <span class='id build_cert'>build_cert</span> <span class='id name'>name</span><span class='comma'>,</span> <span class='id key'>key</span><span class='comma'>,</span> <span class='id opt'>opt</span>

  <span class='kw'>if</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:save_cert</span><span class='rbracket'>]</span> <span class='kw'>then</span>
    <span class='id path'>path</span><span class='lbracket'>[</span><span class='symbol'>:cert</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:save_cert_path</span><span class='rbracket'>]</span> <span class='op'>||</span> <span class='lparen'>(</span><span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:output_fmt</span><span class='rbracket'>]</span> <span class='op'>%</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>public_cert</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>

    <span class='id open'>open</span> <span class='id path'>path</span><span class='lbracket'>[</span><span class='symbol'>:cert</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>wb</span><span class='tstring_end'>'</span></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id file'>file</span><span class='op'>|</span>
      <span class='id file'>file</span><span class='period'>.</span><span class='id chmod'>chmod</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:perms</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:signing_cert</span><span class='rbracket'>]</span>
      <span class='id file'>file</span><span class='period'>.</span><span class='id write'>write</span> <span class='id cert'>cert</span><span class='period'>.</span><span class='id to_pem'>to_pem</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='lbrace'>{</span> <span class='symbol'>:key</span> <span class='op'>=&gt;</span> <span class='id key'>key</span><span class='comma'>,</span> <span class='symbol'>:cert</span> <span class='op'>=&gt;</span> <span class='id cert'>cert</span><span class='comma'>,</span>
    <span class='symbol'>:key_path</span> <span class='op'>=&gt;</span> <span class='id path'>path</span><span class='lbracket'>[</span><span class='symbol'>:key</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='symbol'>:cert_path</span> <span class='op'>=&gt;</span> <span class='id path'>path</span><span class='lbracket'>[</span><span class='symbol'>:cert</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="email_to_name-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>email_to_name</strong>(email_address, munge_re) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Turns <tt>email_address</tt> into an OpenSSL::X509::Name</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


742
743
744
745
746
747
748
749
750
751
752
753
754
755
756</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rubygems/security.rb', line 742</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id email_to_name'>email_to_name</span> <span class='id email_address'>email_address</span><span class='comma'>,</span> <span class='id munge_re'>munge_re</span>
  <span class='id cn'>cn</span><span class='comma'>,</span> <span class='id dcs'>dcs</span> <span class='op'>=</span> <span class='id email_address'>email_address</span><span class='period'>.</span><span class='id split'>split</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>@</span><span class='tstring_end'>'</span></span>

  <span class='id dcs'>dcs</span> <span class='op'>=</span> <span class='id dcs'>dcs</span><span class='period'>.</span><span class='id split'>split</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>.</span><span class='tstring_end'>'</span></span>

  <span class='id cn'>cn</span> <span class='op'>=</span> <span class='id cn'>cn</span><span class='period'>.</span><span class='id gsub'>gsub</span> <span class='id munge_re'>munge_re</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>_</span><span class='tstring_end'>'</span></span>

  <span class='id dcs'>dcs</span> <span class='op'>=</span> <span class='id dcs'>dcs</span><span class='period'>.</span><span class='id map'>map</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id dc'>dc</span><span class='op'>|</span>
    <span class='id dc'>dc</span><span class='period'>.</span><span class='id gsub'>gsub</span> <span class='id munge_re'>munge_re</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>_</span><span class='tstring_end'>'</span></span>
  <span class='kw'>end</span>

  <span class='id name'>name</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CN=</span><span class='embexpr_beg'>#{</span><span class='id cn'>cn</span><span class='rbrace'>}</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span> <span class='op'>&lt;&lt;</span> <span class='id dcs'>dcs</span><span class='period'>.</span><span class='id map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id dc'>dc</span><span class='op'>|</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>DC=</span><span class='embexpr_beg'>#{</span><span class='id dc'>dc</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span><span class='period'>.</span><span class='id join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>/</span><span class='tstring_end'>'</span></span><span class='rparen'>)</span>

  <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>X509</span><span class='op'>::</span><span class='const'>Name</span><span class='period'>.</span><span class='id parse'>parse</span> <span class='id name'>name</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="sign_cert-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>sign_cert</strong>(cert, signing_key, signing_cert, opt = {}) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Sign the cert cert with @signing_key and @signing_cert, using the digest
algorithm opt[:dgst_algo]. Returns the newly signed certificate.</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


641
642
643
644
645
646
647
648</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rubygems/security.rb', line 641</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id sign_cert'>sign_cert</span><span class='lparen'>(</span><span class='id cert'>cert</span><span class='comma'>,</span> <span class='id signing_key'>signing_key</span><span class='comma'>,</span> <span class='id signing_cert'>signing_cert</span><span class='comma'>,</span> <span class='id opt'>opt</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='id opt'>opt</span> <span class='op'>=</span> <span class='const'>OPT</span><span class='period'>.</span><span class='id merge'>merge</span><span class='lparen'>(</span><span class='id opt'>opt</span><span class='rparen'>)</span>

  <span class='id cert'>cert</span><span class='period'>.</span><span class='id issuer'>issuer</span> <span class='op'>=</span> <span class='id signing_cert'>signing_cert</span><span class='period'>.</span><span class='id subject'>subject</span>
  <span class='id cert'>cert</span><span class='period'>.</span><span class='id sign'>sign</span> <span class='id signing_key'>signing_key</span><span class='comma'>,</span> <span class='id opt'>opt</span><span class='lbracket'>[</span><span class='symbol'>:dgst_algo</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id new'>new</span>

  <span class='id cert'>cert</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="verify_trust_dir-class_method">
  
    + (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>verify_trust_dir</strong>(path, perms) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Make sure the trust directory exists.  If it does exist, make sure it's
actually a directory.  If not, then create it with the appropriate
permissions.</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


655
656
657
658
659
660
661
662
663
664
665
666
667
668
669</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rubygems/security.rb', line 655</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id verify_trust_dir'>verify_trust_dir</span><span class='lparen'>(</span><span class='id path'>path</span><span class='comma'>,</span> <span class='id perms'>perms</span><span class='rparen'>)</span>
  <span class='comment'># if the directory exists, then make sure it is in fact a directory.  if
</span>  <span class='comment'># it doesn't exist, then create it with the appropriate permissions
</span>  <span class='kw'>if</span> <span class='const'>File</span><span class='period'>.</span><span class='id exist?'>exist?</span><span class='lparen'>(</span><span class='id path'>path</span><span class='rparen'>)</span>
    <span class='comment'># verify that the trust directory is actually a directory
</span>    <span class='kw'>unless</span> <span class='const'>File</span><span class='period'>.</span><span class='id directory?'>directory?</span><span class='lparen'>(</span><span class='id path'>path</span><span class='rparen'>)</span>
      <span class='id err'>err</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>trust directory </span><span class='embexpr_beg'>#{</span><span class='id path'>path</span><span class='rbrace'>}</span><span class='tstring_content'> isn't a directory</span><span class='tstring_end'>&quot;</span></span>
      <span class='id raise'>raise</span> <span class='const'>Gem</span><span class='op'>::</span><span class='const'>Security</span><span class='op'>::</span><span class='const'>Exception</span><span class='comma'>,</span> <span class='id err'>err</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='comment'># trust directory doesn't exist, so create it with permissions
</span>    <span class='const'>FileUtils</span><span class='period'>.</span><span class='id mkdir_p'>mkdir_p</span><span class='lparen'>(</span><span class='id path'>path</span><span class='rparen'>)</span>
    <span class='const'>FileUtils</span><span class='period'>.</span><span class='id chmod'>chmod</span><span class='lparen'>(</span><span class='id perms'>perms</span><span class='comma'>,</span> <span class='id path'>path</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Sat Sep  3 14:11:22 2011 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.7.2 (ruby-1.9.3).
</div>

  </body>
</html>