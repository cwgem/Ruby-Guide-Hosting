<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: WEBrick::HTTPProxyServer
  
    &mdash; Ruby 1.9 Ruby Standard Library
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  relpath = '..';
  if (relpath != '') relpath += '/';
</script>

  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      if (window.top.frames.main) document.body.className = 'frames';
    </script>
    
    <div id="header">
      <div id="menu">
  
    <a href="../_index.html">Index (H)</a> &raquo; 
    <span class='title'><span class='object_link'><a href="../WEBrick.html" title="WEBrick (module)">WEBrick</a></span></span>
     &raquo; 
    <span class="title">HTTPProxyServer</span>
  
  
  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a id="class_list_link" href="#">Class List</a>
  
    <a id="method_list_link" href="#">Method List</a>
  
    <a id="file_list_link" href="#">File List</a>
  
</div>
      <div class="clear"></div>
    </div>
    
    <iframe id="search_frame"></iframe>
    
    <div id="content"><h1>Class: WEBrick::HTTPProxyServer
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName"><span class='object_link'><a href="HTTPServer.html" title="WEBrick::HTTPServer (class)">HTTPServer</a></span></span>
      
        <ul class="fullTree">
          <li><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></li>
          
            <li class="next"><span class='object_link'><a href="GenericServer.html" title="WEBrick::GenericServer (class)">GenericServer</a></span></li>
          
            <li class="next"><span class='object_link'><a href="HTTPServer.html" title="WEBrick::HTTPServer (class)">HTTPServer</a></span></li>
          
            <li class="next">WEBrick::HTTPProxyServer</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">lib/webrick/httpproxy.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>An HTTP Proxy server which proxies GET, HEAD and POST requests.</p>


  </div>
</div>
<div class="tags">
  
</div>
  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="HopByHop-constant" class="">HopByHop =
          <div class="docstring">
  <div class="discussion">
    
<p>Some header fields should not be transferred.</p>


  </div>
</div>
<div class="tags">
  
</div>
        </dt>
        <dd><pre class="code">['allow'] = &quot;GET,HEAD,POST,OPTIONS,CONNECT&quot;
    end

    private

    # Some header fields should not be transferred.
    HopByHop = %w( connection keep-alive proxy-authenticate upgrade
proxy-authorization te trailers transfer-encoding )</pre></dd>
      
        <dt id="ShouldNotTransfer-constant" class="">ShouldNotTransfer =
          
        </dt>
        <dd><pre class="code">[0].member?(os)
        buf = os.sysread(1024);
        @logger.debug(&quot;CONNECT: #{buf.bytesize} byte from #{host}:#{port}&quot;)
        ua.syswrite(buf)
      end
    end
  rescue =&gt; ex
    os.close
    @logger.debug(&quot;CONNECT #{host}:#{port}: closed&quot;)
  end

  raise HTTPStatus::EOFError
end

def do_GET(req, res)
  perform_proxy_request(req, res) do |http, path, header|
    http.get(path, header)
  end
end

def do_HEAD(req, res)
  perform_proxy_request(req, res) do |http, path, header|
    http.head(path, header)
  end
end

def do_POST(req, res)
  perform_proxy_request(req, res) do |http, path, header|
    http.post(path, req.body || &quot;&quot;, header)
  end
end

def do_OPTIONS(req, res)
  res['allow'] = &quot;GET,HEAD,POST,OPTIONS,CONNECT&quot;
end

private

# Some header fields should not be transferred.
HopByHop = %w( connection keep-alive proxy-authenticate upgrade
               proxy-authorization te trailers transfer-encoding )
ShouldNotTransfer = %w( set-cookie proxy-connection )</pre></dd>
      
    </dl>
  


  
  
  
  
  
  
  
  


  
  
  
  
  
  
  <h2>Instance Attribute Summary</h2>
  
  <h3 class="inherited">Attributes inherited from <span class='object_link'><a href="GenericServer.html" title="WEBrick::GenericServer (class)">GenericServer</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="GenericServer.html#config-instance_method" title="WEBrick::GenericServer#config (method)">config</a></span>, <span class='object_link'><a href="GenericServer.html#listeners-instance_method" title="WEBrick::GenericServer#listeners (method)">listeners</a></span>, <span class='object_link'><a href="GenericServer.html#logger-instance_method" title="WEBrick::GenericServer#logger (method)">logger</a></span>, <span class='object_link'><a href="GenericServer.html#status-instance_method" title="WEBrick::GenericServer#status (method)">status</a></span>, <span class='object_link'><a href="GenericServer.html#tokens-instance_method" title="WEBrick::GenericServer#tokens (method)">tokens</a></span></p>


  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#choose_header-instance_method" title="#choose_header (instance method)">- (Object) <strong>choose_header</strong>(src, dst) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#do_CONNECT-instance_method" title="#do_CONNECT (instance method)">- (Object) <strong>do_CONNECT</strong>(req, res) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#do_GET-instance_method" title="#do_GET (instance method)">- (Object) <strong>do_GET</strong>(req, res) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#do_HEAD-instance_method" title="#do_HEAD (instance method)">- (Object) <strong>do_HEAD</strong>(req, res) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#do_OPTIONS-instance_method" title="#do_OPTIONS (instance method)">- (Object) <strong>do_OPTIONS</strong>(req, res) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#do_POST-instance_method" title="#do_POST (instance method)">- (Object) <strong>do_POST</strong>(req, res) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">- (HTTPProxyServer) <strong>initialize</strong>(config = {}, default = Config::HTTP) </a>
    

    
  </span>
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Proxy server configurations.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#perform_proxy_request-instance_method" title="#perform_proxy_request (instance method)">- (Object) <strong>perform_proxy_request</strong>(req, res) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#proxy_auth-instance_method" title="#proxy_auth (instance method)">- (Object) <strong>proxy_auth</strong>(req, res) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#proxy_service-instance_method" title="#proxy_service (instance method)">- (Object) <strong>proxy_service</strong>(req, res) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#proxy_uri-instance_method" title="#proxy_uri (instance method)">- (Object) <strong>proxy_uri</strong>(req, res) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#service-instance_method" title="#service (instance method)">- (Object) <strong>service</strong>(req, res) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#set_cookie-instance_method" title="#set_cookie (instance method)">- (Object) <strong>set_cookie</strong>(src, dst) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Net::HTTP is stupid about the multiple header fields.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#set_via-instance_method" title="#set_via (instance method)">- (Object) <strong>set_via</strong>(h) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#setup_proxy_header-instance_method" title="#setup_proxy_header (instance method)">- (Object) <strong>setup_proxy_header</strong>(req, res) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#setup_upstream_proxy_authentication-instance_method" title="#setup_upstream_proxy_authentication (instance method)">- (Object) <strong>setup_upstream_proxy_authentication</strong>(req, res, header) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#split_field-instance_method" title="#split_field (instance method)">- (Object) <strong>split_field</strong>(f) </a>
    

    
  </span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  <h3 class="inherited">Methods inherited from <span class='object_link'><a href="HTTPServer.html" title="WEBrick::HTTPServer (class)">HTTPServer</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="HTTPServer.html#access_log-instance_method" title="WEBrick::HTTPServer#access_log (method)">#access_log</a></span>, <span class='object_link'><a href="HTTPServer.html#lookup_server-instance_method" title="WEBrick::HTTPServer#lookup_server (method)">#lookup_server</a></span>, <span class='object_link'><a href="HTTPServer.html#mount-instance_method" title="WEBrick::HTTPServer#mount (method)">#mount</a></span>, <span class='object_link'><a href="HTTPServer.html#mount_proc-instance_method" title="WEBrick::HTTPServer#mount_proc (method)">#mount_proc</a></span>, <span class='object_link'><a href="HTTPServer.html#run-instance_method" title="WEBrick::HTTPServer#run (method)">#run</a></span>, <span class='object_link'><a href="HTTPServer.html#search_servlet-instance_method" title="WEBrick::HTTPServer#search_servlet (method)">#search_servlet</a></span>, <span class='object_link'><a href="HTTPServer.html#unmount-instance_method" title="WEBrick::HTTPServer#unmount (method)">#unmount</a></span>, <span class='object_link'><a href="HTTPServer.html#virtual_host-instance_method" title="WEBrick::HTTPServer#virtual_host (method)">#virtual_host</a></span></p>

  
  
  
  
  
  
  
  <h3 class="inherited">Methods inherited from <span class='object_link'><a href="GenericServer.html" title="WEBrick::GenericServer (class)">GenericServer</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="GenericServer.html#%5B%5D-instance_method" title="WEBrick::GenericServer#[] (method)">#[]</a></span>, <span class='object_link'><a href="GenericServer.html#accept_client-instance_method" title="WEBrick::GenericServer#accept_client (method)">#accept_client</a></span>, <span class='object_link'><a href="GenericServer.html#call_callback-instance_method" title="WEBrick::GenericServer#call_callback (method)">#call_callback</a></span>, <span class='object_link'><a href="GenericServer.html#listen-instance_method" title="WEBrick::GenericServer#listen (method)">#listen</a></span>, <span class='object_link'><a href="GenericServer.html#run-instance_method" title="WEBrick::GenericServer#run (method)">#run</a></span>, <span class='object_link'><a href="GenericServer.html#setup_ssl_context-instance_method" title="WEBrick::GenericServer#setup_ssl_context (method)">#setup_ssl_context</a></span>, <span class='object_link'><a href="GenericServer.html#shutdown-instance_method" title="WEBrick::GenericServer#shutdown (method)">#shutdown</a></span>, <span class='object_link'><a href="GenericServer.html#ssl_context-instance_method" title="WEBrick::GenericServer#ssl_context (method)">#ssl_context</a></span>, <span class='object_link'><a href="GenericServer.html#start-instance_method" title="WEBrick::GenericServer#start (method)">#start</a></span>, <span class='object_link'><a href="GenericServer.html#start_thread-instance_method" title="WEBrick::GenericServer#start_thread (method)">#start_thread</a></span>, <span class='object_link'><a href="GenericServer.html#stop-instance_method" title="WEBrick::GenericServer#stop (method)">#stop</a></span></p>
<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <p class="signature first" id="initialize-instance_method">
  
    - (<tt><span class='object_link'><a href="" title="WEBrick::HTTPProxyServer (class)">HTTPProxyServer</a></span></tt>) <strong>initialize</strong>(config = {}, default = Config::HTTP) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Proxy server configurations.  The proxy server handles the following
configuration items in addition to those supported by HTTPServer:</p>
<table class="rdoc-list"><tr><td class="rdoc-term"><p>:ProxyAuthProc</p></td>
<td>
<p>Called with a request and response to authorize a request</p>
</td></tr><tr><td class="rdoc-term"><p>:ProxyVia</p></td>
<td>
<p>Appended to the via header</p>
</td></tr><tr><td class="rdoc-term"><p>:ProxyURI</p></td>
<td>
<p>The proxy server's URI</p>
</td></tr><tr><td class="rdoc-term"><p>:ProxyContentHandler</p></td>
<td>
<p>Called with a request and resopnse and allows modification of the response</p>
</td></tr><tr><td class="rdoc-term"><p>:ProxyTimeout</p></td>
<td>
<p>Sets the proxy timeouts to 30 seconds for open and 60 seconds for read
operations</p>
</td></tr></table>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


54
55
56
57
58</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/webrick/httpproxy.rb', line 54</span>

<span class='kw'>def</span> <span class='id initialize'>initialize</span><span class='lparen'>(</span><span class='id config'>config</span><span class='op'>=</span><span class='lbrace'>{</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='id default'>default</span><span class='op'>=</span><span class='const'>Config</span><span class='op'>::</span><span class='const'>HTTP</span><span class='rparen'>)</span>
  <span class='kw'>super</span><span class='lparen'>(</span><span class='id config'>config</span><span class='comma'>,</span> <span class='id default'>default</span><span class='rparen'>)</span>
  <span class='id c'>c</span> <span class='op'>=</span> <span class='ivar'>@config</span>
  <span class='ivar'>@via</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id c'>c</span><span class='lbracket'>[</span><span class='symbol'>:HTTPVersion</span><span class='rbracket'>]</span><span class='rbrace'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id c'>c</span><span class='lbracket'>[</span><span class='symbol'>:ServerName</span><span class='rbracket'>]</span><span class='rbrace'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id c'>c</span><span class='lbracket'>[</span><span class='symbol'>:Port</span><span class='rbracket'>]</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>
    
    
      <div class="method_details first">
  <p class="signature first" id="choose_header-instance_method">
  
    - (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>choose_header</strong>(src, dst) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


212
213
214
215
216
217
218
219
220
221
222
223
224</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/webrick/httpproxy.rb', line 212</span>

<span class='kw'>def</span> <span class='id choose_header'>choose_header</span><span class='lparen'>(</span><span class='id src'>src</span><span class='comma'>,</span> <span class='id dst'>dst</span><span class='rparen'>)</span>
  <span class='id connections'>connections</span> <span class='op'>=</span> <span class='id split_field'>split_field</span><span class='lparen'>(</span><span class='id src'>src</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>connection</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
  <span class='id src'>src</span><span class='period'>.</span><span class='id each'>each</span><span class='lbrace'>{</span><span class='op'>|</span><span class='id key'>key</span><span class='comma'>,</span> <span class='id value'>value</span><span class='op'>|</span>
    <span class='id key'>key</span> <span class='op'>=</span> <span class='id key'>key</span><span class='period'>.</span><span class='id downcase'>downcase</span>
    <span class='kw'>if</span> <span class='const'>HopByHop</span><span class='period'>.</span><span class='id member?'>member?</span><span class='lparen'>(</span><span class='id key'>key</span><span class='rparen'>)</span>          <span class='op'>||</span> <span class='comment'># RFC2616: 13.5.1
</span>       <span class='id connections'>connections</span><span class='period'>.</span><span class='id member?'>member?</span><span class='lparen'>(</span><span class='id key'>key</span><span class='rparen'>)</span>       <span class='op'>||</span> <span class='comment'># RFC2616: 14.10
</span>       <span class='const'>ShouldNotTransfer</span><span class='period'>.</span><span class='id member?'>member?</span><span class='lparen'>(</span><span class='id key'>key</span><span class='rparen'>)</span>    <span class='comment'># pragmatics
</span>      <span class='ivar'>@logger</span><span class='period'>.</span><span class='id debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>choose_header: `</span><span class='embexpr_beg'>#{</span><span class='id key'>key</span><span class='rbrace'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id value'>value</span><span class='rbrace'>}</span><span class='tstring_content'>'</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>next</span>
    <span class='kw'>end</span>
    <span class='id dst'>dst</span><span class='lbracket'>[</span><span class='id key'>key</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id value'>value</span>
  <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="do_CONNECT-instance_method">
  
    - (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>do_CONNECT</strong>(req, res) 
  

  
</p><div class="docstring">
  <div class="discussion">
    

  </div>
</div>
<div class="tags">
  <h3>Raises:</h3>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt>HTTPStatus::InternalServerError</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/webrick/httpproxy.rb', line 102</span>

<span class='kw'>def</span> <span class='id do_CONNECT'>do_CONNECT</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span>
  <span class='comment'># Proxy Authentication
</span>  <span class='id proxy_auth'>proxy_auth</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span>

  <span class='id ua'>ua</span> <span class='op'>=</span> <span class='const'>Thread</span><span class='period'>.</span><span class='id current'>current</span><span class='lbracket'>[</span><span class='symbol'>:WEBrickSocket</span><span class='rbracket'>]</span>  <span class='comment'># User-Agent
</span>  <span class='id raise'>raise</span> <span class='const'>HTTPStatus</span><span class='op'>::</span><span class='const'>InternalServerError</span><span class='comma'>,</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[BUG] cannot get socket</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id ua'>ua</span>

  <span class='id host'>host</span><span class='comma'>,</span> <span class='id port'>port</span> <span class='op'>=</span> <span class='id req'>req</span><span class='period'>.</span><span class='id unparsed_uri'>unparsed_uri</span><span class='period'>.</span><span class='id split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>:</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>2</span><span class='rparen'>)</span>
  <span class='comment'># Proxy authentication for upstream proxy server
</span>  <span class='kw'>if</span> <span class='id proxy'>proxy</span> <span class='op'>=</span> <span class='id proxy_uri'>proxy_uri</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span>
    <span class='id proxy_request_line'>proxy_request_line</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CONNECT </span><span class='embexpr_beg'>#{</span><span class='id host'>host</span><span class='rbrace'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id port'>port</span><span class='rbrace'>}</span><span class='tstring_content'> HTTP/1.0</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>if</span> <span class='id proxy'>proxy</span><span class='period'>.</span><span class='id userinfo'>userinfo</span>
      <span class='id credentials'>credentials</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Basic </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='lbracket'>[</span><span class='id proxy'>proxy</span><span class='period'>.</span><span class='id userinfo'>userinfo</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id pack'>pack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>m</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id delete'>delete</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='id host'>host</span><span class='comma'>,</span> <span class='id port'>port</span> <span class='op'>=</span> <span class='id proxy'>proxy</span><span class='period'>.</span><span class='id host'>host</span><span class='comma'>,</span> <span class='id proxy'>proxy</span><span class='period'>.</span><span class='id port'>port</span>
  <span class='kw'>end</span>

  <span class='kw'>begin</span>
    <span class='ivar'>@logger</span><span class='period'>.</span><span class='id debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CONNECT: upstream proxy is `</span><span class='embexpr_beg'>#{</span><span class='id host'>host</span><span class='rbrace'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id port'>port</span><span class='rbrace'>}</span><span class='tstring_content'>'.</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='id os'>os</span> <span class='op'>=</span> <span class='const'>TCPSocket</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='id host'>host</span><span class='comma'>,</span> <span class='id port'>port</span><span class='rparen'>)</span>     <span class='comment'># origin server
</span>
    <span class='kw'>if</span> <span class='id proxy'>proxy</span>
      <span class='ivar'>@logger</span><span class='period'>.</span><span class='id debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CONNECT: sending a Request-Line</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='id os'>os</span> <span class='op'>&lt;&lt;</span> <span class='id proxy_request_line'>proxy_request_line</span> <span class='op'>&lt;&lt;</span> <span class='const'>CRLF</span>
      <span class='ivar'>@logger</span><span class='period'>.</span><span class='id debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CONNECT: &gt; </span><span class='embexpr_beg'>#{</span><span class='id proxy_request_line'>proxy_request_line</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>if</span> <span class='id credentials'>credentials</span>
        <span class='ivar'>@logger</span><span class='period'>.</span><span class='id debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CONNECT: sending a credentials</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
        <span class='id os'>os</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Proxy-Authorization: </span><span class='tstring_end'>&quot;</span></span> <span class='op'>&lt;&lt;</span> <span class='id credentials'>credentials</span> <span class='op'>&lt;&lt;</span> <span class='const'>CRLF</span>
      <span class='kw'>end</span>
      <span class='id os'>os</span> <span class='op'>&lt;&lt;</span> <span class='const'>CRLF</span>
      <span class='id proxy_status_line'>proxy_status_line</span> <span class='op'>=</span> <span class='id os'>os</span><span class='period'>.</span><span class='id gets'>gets</span><span class='lparen'>(</span><span class='const'>LF</span><span class='rparen'>)</span>
      <span class='ivar'>@logger</span><span class='period'>.</span><span class='id debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CONNECT: read a Status-Line form the upstream server</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='ivar'>@logger</span><span class='period'>.</span><span class='id debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CONNECT: &lt; </span><span class='embexpr_beg'>#{</span><span class='id proxy_status_line'>proxy_status_line</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>if</span> <span class='tstring'><span class='regexp_beg'>%r{</span><span class='tstring_content'>^HTTP/\d+\.\d+\s+200\s*</span><span class='regexp_end'>}</span></span> <span class='op'>=~</span> <span class='id proxy_status_line'>proxy_status_line</span>
        <span class='kw'>while</span> <span class='id line'>line</span> <span class='op'>=</span> <span class='id os'>os</span><span class='period'>.</span><span class='id gets'>gets</span><span class='lparen'>(</span><span class='const'>LF</span><span class='rparen'>)</span>
          <span class='kw'>break</span> <span class='kw'>if</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\A(</span><span class='embexpr_beg'>#{</span><span class='const'>CRLF</span><span class='rbrace'>}</span><span class='tstring_content'>|</span><span class='embexpr_beg'>#{</span><span class='const'>LF</span><span class='rbrace'>}</span><span class='tstring_content'>)\z</span><span class='regexp_end'>/om</span></span> <span class='op'>=~</span> <span class='id line'>line</span>
        <span class='kw'>end</span>
      <span class='kw'>else</span>
        <span class='id raise'>raise</span> <span class='const'>HTTPStatus</span><span class='op'>::</span><span class='const'>BadGateway</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='ivar'>@logger</span><span class='period'>.</span><span class='id debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CONNECT </span><span class='embexpr_beg'>#{</span><span class='id host'>host</span><span class='rbrace'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id port'>port</span><span class='rbrace'>}</span><span class='tstring_content'>: succeeded</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='id res'>res</span><span class='period'>.</span><span class='id status'>status</span> <span class='op'>=</span> <span class='const'>HTTPStatus</span><span class='op'>::</span><span class='const'>RC_OK</span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id ex'>ex</span>
    <span class='ivar'>@logger</span><span class='period'>.</span><span class='id debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CONNECT </span><span class='embexpr_beg'>#{</span><span class='id host'>host</span><span class='rbrace'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id port'>port</span><span class='rbrace'>}</span><span class='tstring_content'>: failed `</span><span class='embexpr_beg'>#{</span><span class='id ex'>ex</span><span class='period'>.</span><span class='id message'>message</span><span class='rbrace'>}</span><span class='tstring_content'>'</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='id res'>res</span><span class='period'>.</span><span class='id set_error'>set_error</span><span class='lparen'>(</span><span class='id ex'>ex</span><span class='rparen'>)</span>
    <span class='id raise'>raise</span> <span class='const'>HTTPStatus</span><span class='op'>::</span><span class='const'>EOFError</span>
  <span class='kw'>ensure</span>
    <span class='kw'>if</span> <span class='id handler'>handler</span> <span class='op'>=</span> <span class='ivar'>@config</span><span class='lbracket'>[</span><span class='symbol'>:ProxyContentHandler</span><span class='rbracket'>]</span>
      <span class='id handler'>handler</span><span class='period'>.</span><span class='id call'>call</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='id res'>res</span><span class='period'>.</span><span class='id send_response'>send_response</span><span class='lparen'>(</span><span class='id ua'>ua</span><span class='rparen'>)</span>
    <span class='id access_log'>access_log</span><span class='lparen'>(</span><span class='ivar'>@config</span><span class='comma'>,</span> <span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span>

    <span class='comment'># Should clear request-line not to send the sesponse twice.
</span>    <span class='comment'># see: HTTPServer#run
</span>    <span class='id req'>req</span><span class='period'>.</span><span class='id parse'>parse</span><span class='lparen'>(</span><span class='const'>NullReader</span><span class='rparen'>)</span> <span class='kw'>rescue</span> <span class='kw'>nil</span>
  <span class='kw'>end</span>

  <span class='kw'>begin</span>
    <span class='kw'>while</span> <span class='id fds'>fds</span> <span class='op'>=</span> <span class='const'>IO</span><span class='op'>::</span><span class='id select'>select</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='id ua'>ua</span><span class='comma'>,</span> <span class='id os'>os</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='kw'>if</span> <span class='id fds'>fds</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id member?'>member?</span><span class='lparen'>(</span><span class='id ua'>ua</span><span class='rparen'>)</span>
        <span class='id buf'>buf</span> <span class='op'>=</span> <span class='id ua'>ua</span><span class='period'>.</span><span class='id sysread'>sysread</span><span class='lparen'>(</span><span class='int'>1024</span><span class='rparen'>)</span><span class='semicolon'>;</span>
        <span class='ivar'>@logger</span><span class='period'>.</span><span class='id debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CONNECT: </span><span class='embexpr_beg'>#{</span><span class='id buf'>buf</span><span class='period'>.</span><span class='id bytesize'>bytesize</span><span class='rbrace'>}</span><span class='tstring_content'> byte from User-Agent</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
        <span class='id os'>os</span><span class='period'>.</span><span class='id syswrite'>syswrite</span><span class='lparen'>(</span><span class='id buf'>buf</span><span class='rparen'>)</span>
      <span class='kw'>elsif</span> <span class='id fds'>fds</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id member?'>member?</span><span class='lparen'>(</span><span class='id os'>os</span><span class='rparen'>)</span>
        <span class='id buf'>buf</span> <span class='op'>=</span> <span class='id os'>os</span><span class='period'>.</span><span class='id sysread'>sysread</span><span class='lparen'>(</span><span class='int'>1024</span><span class='rparen'>)</span><span class='semicolon'>;</span>
        <span class='ivar'>@logger</span><span class='period'>.</span><span class='id debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CONNECT: </span><span class='embexpr_beg'>#{</span><span class='id buf'>buf</span><span class='period'>.</span><span class='id bytesize'>bytesize</span><span class='rbrace'>}</span><span class='tstring_content'> byte from </span><span class='embexpr_beg'>#{</span><span class='id host'>host</span><span class='rbrace'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id port'>port</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
        <span class='id ua'>ua</span><span class='period'>.</span><span class='id syswrite'>syswrite</span><span class='lparen'>(</span><span class='id buf'>buf</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id ex'>ex</span>
    <span class='id os'>os</span><span class='period'>.</span><span class='id close'>close</span>
    <span class='ivar'>@logger</span><span class='period'>.</span><span class='id debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CONNECT </span><span class='embexpr_beg'>#{</span><span class='id host'>host</span><span class='rbrace'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id port'>port</span><span class='rbrace'>}</span><span class='tstring_content'>: closed</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id raise'>raise</span> <span class='const'>HTTPStatus</span><span class='op'>::</span><span class='const'>EOFError</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="do_GET-instance_method">
  
    - (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>do_GET</strong>(req, res) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


182
183
184
185
186</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/webrick/httpproxy.rb', line 182</span>

<span class='kw'>def</span> <span class='id do_GET'>do_GET</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span>
  <span class='id perform_proxy_request'>perform_proxy_request</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id http'>http</span><span class='comma'>,</span> <span class='id path'>path</span><span class='comma'>,</span> <span class='id header'>header</span><span class='op'>|</span>
    <span class='id http'>http</span><span class='period'>.</span><span class='id get'>get</span><span class='lparen'>(</span><span class='id path'>path</span><span class='comma'>,</span> <span class='id header'>header</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="do_HEAD-instance_method">
  
    - (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>do_HEAD</strong>(req, res) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


188
189
190
191
192</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/webrick/httpproxy.rb', line 188</span>

<span class='kw'>def</span> <span class='id do_HEAD'>do_HEAD</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span>
  <span class='id perform_proxy_request'>perform_proxy_request</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id http'>http</span><span class='comma'>,</span> <span class='id path'>path</span><span class='comma'>,</span> <span class='id header'>header</span><span class='op'>|</span>
    <span class='id http'>http</span><span class='period'>.</span><span class='id head'>head</span><span class='lparen'>(</span><span class='id path'>path</span><span class='comma'>,</span> <span class='id header'>header</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="do_OPTIONS-instance_method">
  
    - (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>do_OPTIONS</strong>(req, res) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


200
201
202</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/webrick/httpproxy.rb', line 200</span>

<span class='kw'>def</span> <span class='id do_OPTIONS'>do_OPTIONS</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span>
  <span class='id res'>res</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>allow</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>GET,HEAD,POST,OPTIONS,CONNECT</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="do_POST-instance_method">
  
    - (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>do_POST</strong>(req, res) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


194
195
196
197
198</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/webrick/httpproxy.rb', line 194</span>

<span class='kw'>def</span> <span class='id do_POST'>do_POST</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span>
  <span class='id perform_proxy_request'>perform_proxy_request</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id http'>http</span><span class='comma'>,</span> <span class='id path'>path</span><span class='comma'>,</span> <span class='id header'>header</span><span class='op'>|</span>
    <span class='id http'>http</span><span class='period'>.</span><span class='id post'>post</span><span class='lparen'>(</span><span class='id path'>path</span><span class='comma'>,</span> <span class='id req'>req</span><span class='period'>.</span><span class='id body'>body</span> <span class='op'>||</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id header'>header</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="perform_proxy_request-instance_method">
  
    - (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>perform_proxy_request</strong>(req, res) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/webrick/httpproxy.rb', line 273</span>

<span class='kw'>def</span> <span class='id perform_proxy_request'>perform_proxy_request</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span>
  <span class='id uri'>uri</span> <span class='op'>=</span> <span class='id req'>req</span><span class='period'>.</span><span class='id request_uri'>request_uri</span>
  <span class='id path'>path</span> <span class='op'>=</span> <span class='id uri'>uri</span><span class='period'>.</span><span class='id path'>path</span><span class='period'>.</span><span class='id dup'>dup</span>
  <span class='id path'>path</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>?</span><span class='tstring_end'>&quot;</span></span> <span class='op'>&lt;&lt;</span> <span class='id uri'>uri</span><span class='period'>.</span><span class='id query'>query</span> <span class='kw'>if</span> <span class='id uri'>uri</span><span class='period'>.</span><span class='id query'>query</span>
  <span class='id header'>header</span> <span class='op'>=</span> <span class='id setup_proxy_header'>setup_proxy_header</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span>
  <span class='id upstream'>upstream</span> <span class='op'>=</span> <span class='id setup_upstream_proxy_authentication'>setup_upstream_proxy_authentication</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='comma'>,</span> <span class='id header'>header</span><span class='rparen'>)</span>
  <span class='id response'>response</span> <span class='op'>=</span> <span class='kw'>nil</span>

  <span class='id http'>http</span> <span class='op'>=</span> <span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id new'>new</span><span class='lparen'>(</span><span class='id uri'>uri</span><span class='period'>.</span><span class='id host'>host</span><span class='comma'>,</span> <span class='id uri'>uri</span><span class='period'>.</span><span class='id port'>port</span><span class='comma'>,</span> <span class='id upstream'>upstream</span><span class='period'>.</span><span class='id host'>host</span><span class='comma'>,</span> <span class='id upstream'>upstream</span><span class='period'>.</span><span class='id port'>port</span><span class='rparen'>)</span>
  <span class='id http'>http</span><span class='period'>.</span><span class='id start'>start</span> <span class='kw'>do</span>
    <span class='kw'>if</span> <span class='ivar'>@config</span><span class='lbracket'>[</span><span class='symbol'>:ProxyTimeout</span><span class='rbracket'>]</span>
      <span class='comment'>##################################   these issues are
</span>      <span class='id http'>http</span><span class='period'>.</span><span class='id open_timeout'>open_timeout</span> <span class='op'>=</span> <span class='int'>30</span>   <span class='comment'># secs  #   necessary (maybe bacause
</span>      <span class='id http'>http</span><span class='period'>.</span><span class='id read_timeout'>read_timeout</span> <span class='op'>=</span> <span class='int'>60</span>   <span class='comment'># secs  #   Ruby's bug, but why?)
</span>      <span class='comment'>##################################
</span>    <span class='kw'>end</span>
    <span class='id response'>response</span> <span class='op'>=</span> <span class='kw'>yield</span><span class='lparen'>(</span><span class='id http'>http</span><span class='comma'>,</span> <span class='id path'>path</span><span class='comma'>,</span> <span class='id header'>header</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Persistent connection requirements are mysterious for me.
</span>  <span class='comment'># So I will close the connection in every response.
</span>  <span class='id res'>res</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>proxy-connection</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>close</span><span class='tstring_end'>&quot;</span></span>
  <span class='id res'>res</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>connection</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>close</span><span class='tstring_end'>&quot;</span></span>

  <span class='comment'># Convert Net::HTTP::HTTPResponse to WEBrick::HTTPResponse
</span>  <span class='id res'>res</span><span class='period'>.</span><span class='id status'>status</span> <span class='op'>=</span> <span class='id response'>response</span><span class='period'>.</span><span class='id code'>code</span><span class='period'>.</span><span class='id to_i'>to_i</span>
  <span class='id choose_header'>choose_header</span><span class='lparen'>(</span><span class='id response'>response</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span>
  <span class='id set_cookie'>set_cookie</span><span class='lparen'>(</span><span class='id response'>response</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span>
  <span class='id set_via'>set_via</span><span class='lparen'>(</span><span class='id res'>res</span><span class='rparen'>)</span>
  <span class='id res'>res</span><span class='period'>.</span><span class='id body'>body</span> <span class='op'>=</span> <span class='id response'>response</span><span class='period'>.</span><span class='id body'>body</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="proxy_auth-instance_method">
  
    - (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>proxy_auth</strong>(req, res) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


70
71
72
73
74
75</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/webrick/httpproxy.rb', line 70</span>

<span class='kw'>def</span> <span class='id proxy_auth'>proxy_auth</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id proc'>proc</span> <span class='op'>=</span> <span class='ivar'>@config</span><span class='lbracket'>[</span><span class='symbol'>:ProxyAuthProc</span><span class='rbracket'>]</span>
    <span class='id proc'>proc</span><span class='period'>.</span><span class='id call'>call</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='id req'>req</span><span class='period'>.</span><span class='id header'>header</span><span class='period'>.</span><span class='id delete'>delete</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>proxy-authorization</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="proxy_service-instance_method">
  
    - (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>proxy_service</strong>(req, res) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/webrick/httpproxy.rb', line 82</span>

<span class='kw'>def</span> <span class='id proxy_service'>proxy_service</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span>
  <span class='comment'># Proxy Authentication
</span>  <span class='id proxy_auth'>proxy_auth</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span>

  <span class='kw'>begin</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id send'>send</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>do_</span><span class='embexpr_beg'>#{</span><span class='id req'>req</span><span class='period'>.</span><span class='id request_method'>request_method</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span> <span class='const'>NoMethodError</span>
    <span class='id raise'>raise</span> <span class='const'>HTTPStatus</span><span class='op'>::</span><span class='const'>MethodNotAllowed</span><span class='comma'>,</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>unsupported method `</span><span class='embexpr_beg'>#{</span><span class='id req'>req</span><span class='period'>.</span><span class='id request_method'>request_method</span><span class='rbrace'>}</span><span class='tstring_content'>'.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id err'>err</span>
    <span class='id logger'>logger</span><span class='period'>.</span><span class='id debug'>debug</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id err'>err</span><span class='period'>.</span><span class='id class'>class</span><span class='rbrace'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id err'>err</span><span class='period'>.</span><span class='id message'>message</span><span class='rbrace'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='id raise'>raise</span> <span class='const'>HTTPStatus</span><span class='op'>::</span><span class='const'>ServiceUnavailable</span><span class='comma'>,</span> <span class='id err'>err</span><span class='period'>.</span><span class='id message'>message</span>
  <span class='kw'>end</span>

  <span class='comment'># Process contents
</span>  <span class='kw'>if</span> <span class='id handler'>handler</span> <span class='op'>=</span> <span class='ivar'>@config</span><span class='lbracket'>[</span><span class='symbol'>:ProxyContentHandler</span><span class='rbracket'>]</span>
    <span class='id handler'>handler</span><span class='period'>.</span><span class='id call'>call</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="proxy_uri-instance_method">
  
    - (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>proxy_uri</strong>(req, res) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


77
78
79
80</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/webrick/httpproxy.rb', line 77</span>

<span class='kw'>def</span> <span class='id proxy_uri'>proxy_uri</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span>
  <span class='comment'># should return upstream proxy server's URI
</span>  <span class='kw'>return</span> <span class='ivar'>@config</span><span class='lbracket'>[</span><span class='symbol'>:ProxyURI</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="service-instance_method">
  
    - (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>service</strong>(req, res) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


60
61
62
63
64
65
66
67
68</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/webrick/httpproxy.rb', line 60</span>

<span class='kw'>def</span> <span class='id service'>service</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id req'>req</span><span class='period'>.</span><span class='id request_method'>request_method</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>CONNECT</span><span class='tstring_end'>&quot;</span></span>
    <span class='id do_CONNECT'>do_CONNECT</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span>
  <span class='kw'>elsif</span> <span class='id req'>req</span><span class='period'>.</span><span class='id unparsed_uri'>unparsed_uri</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>%r!</span><span class='tstring_content'>^http://</span><span class='regexp_end'>!</span></span>
    <span class='id proxy_service'>proxy_service</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='kw'>super</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="set_cookie-instance_method">
  
    - (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>set_cookie</strong>(src, dst) 
  

  
</p><div class="docstring">
  <div class="discussion">
    
<p>Net::HTTP is stupid about the multiple header fields. Here is workaround:</p>


  </div>
</div>
<div class="tags">
  
</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


228
229
230
231
232
233
234
235
236
237
238
239
240
241
242</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/webrick/httpproxy.rb', line 228</span>

<span class='kw'>def</span> <span class='id set_cookie'>set_cookie</span><span class='lparen'>(</span><span class='id src'>src</span><span class='comma'>,</span> <span class='id dst'>dst</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id str'>str</span> <span class='op'>=</span> <span class='id src'>src</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>set-cookie</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span>
    <span class='id cookies'>cookies</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
    <span class='id str'>str</span><span class='period'>.</span><span class='id split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>,\s*</span><span class='regexp_end'>/</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id each'>each</span><span class='lbrace'>{</span><span class='op'>|</span><span class='id token'>token</span><span class='op'>|</span>
      <span class='kw'>if</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^[^=]+;</span><span class='regexp_end'>/o</span></span> <span class='op'>=~</span> <span class='id token'>token</span>
        <span class='id cookies'>cookies</span><span class='lbracket'>[</span><span class='op'>-</span><span class='int'>1</span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>, </span><span class='tstring_end'>&quot;</span></span> <span class='op'>&lt;&lt;</span> <span class='id token'>token</span>
      <span class='kw'>elsif</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>=</span><span class='regexp_end'>/o</span></span> <span class='op'>=~</span> <span class='id token'>token</span>
        <span class='id cookies'>cookies</span> <span class='op'>&lt;&lt;</span> <span class='id token'>token</span>
      <span class='kw'>else</span>
        <span class='id cookies'>cookies</span><span class='lbracket'>[</span><span class='op'>-</span><span class='int'>1</span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>, </span><span class='tstring_end'>&quot;</span></span> <span class='op'>&lt;&lt;</span> <span class='id token'>token</span>
      <span class='kw'>end</span>
    <span class='rbrace'>}</span>
    <span class='id dst'>dst</span><span class='period'>.</span><span class='id cookies'>cookies</span><span class='period'>.</span><span class='id replace'>replace</span><span class='lparen'>(</span><span class='id cookies'>cookies</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="set_via-instance_method">
  
    - (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>set_via</strong>(h) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


244
245
246
247
248
249
250
251
252</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/webrick/httpproxy.rb', line 244</span>

<span class='kw'>def</span> <span class='id set_via'>set_via</span><span class='lparen'>(</span><span class='id h'>h</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='ivar'>@config</span><span class='lbracket'>[</span><span class='symbol'>:ProxyVia</span><span class='rbracket'>]</span>
    <span class='kw'>if</span>  <span class='id h'>h</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>via</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span>
      <span class='id h'>h</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>via</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>, </span><span class='tstring_end'>&quot;</span></span> <span class='op'>&lt;&lt;</span> <span class='ivar'>@via</span>
    <span class='kw'>else</span>
      <span class='id h'>h</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>via</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='ivar'>@via</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="setup_proxy_header-instance_method">
  
    - (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>setup_proxy_header</strong>(req, res) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


254
255
256
257
258
259
260</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/webrick/httpproxy.rb', line 254</span>

<span class='kw'>def</span> <span class='id setup_proxy_header'>setup_proxy_header</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span>
  <span class='comment'># Choose header fields to transfer
</span>  <span class='id header'>header</span> <span class='op'>=</span> <span class='const'>Hash</span><span class='period'>.</span><span class='id new'>new</span>
  <span class='id choose_header'>choose_header</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id header'>header</span><span class='rparen'>)</span>
  <span class='id set_via'>set_via</span><span class='lparen'>(</span><span class='id header'>header</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='id header'>header</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="setup_upstream_proxy_authentication-instance_method">
  
    - (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>setup_upstream_proxy_authentication</strong>(req, res, header) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


262
263
264
265
266
267
268
269
270
271</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/webrick/httpproxy.rb', line 262</span>

<span class='kw'>def</span> <span class='id setup_upstream_proxy_authentication'>setup_upstream_proxy_authentication</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='comma'>,</span> <span class='id header'>header</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id upstream'>upstream</span> <span class='op'>=</span> <span class='id proxy_uri'>proxy_uri</span><span class='lparen'>(</span><span class='id req'>req</span><span class='comma'>,</span> <span class='id res'>res</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id upstream'>upstream</span><span class='period'>.</span><span class='id userinfo'>userinfo</span>
      <span class='id header'>header</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>'</span><span class='tstring_content'>proxy-authorization</span><span class='tstring_end'>'</span></span><span class='rbracket'>]</span> <span class='op'>=</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Basic </span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='lbracket'>[</span><span class='id upstream'>upstream</span><span class='period'>.</span><span class='id userinfo'>userinfo</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id pack'>pack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>m</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id delete'>delete</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='kw'>return</span> <span class='id upstream'>upstream</span>
  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='const'>FakeProxyURI</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <p class="signature " id="split_field-instance_method">
  
    - (<tt><span class='object_link'><a href="../Object.html" title="Object (class)">Object</a></span></tt>) <strong>split_field</strong>(f) 
  

  
</p><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


210</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/webrick/httpproxy.rb', line 210</span>

<span class='kw'>def</span> <span class='id split_field'>split_field</span><span class='lparen'>(</span><span class='id f'>f</span><span class='rparen'>)</span> <span class='id f'>f</span> <span class='op'>?</span> <span class='id f'>f</span><span class='period'>.</span><span class='id split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>,\s+</span><span class='regexp_end'>/</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id collect'>collect</span><span class='lbrace'>{</span><span class='op'>|</span><span class='id i'>i</span><span class='op'>|</span> <span class='id i'>i</span><span class='period'>.</span><span class='id downcase'>downcase</span> <span class='rbrace'>}</span> <span class='op'>:</span> <span class='lbracket'>[</span><span class='rbracket'>]</span> <span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>
    
    <div id="footer">
  Generated on Sat Sep  3 14:11:20 2011 by 
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.7.2 (ruby-1.9.3).
</div>

  </body>
</html>